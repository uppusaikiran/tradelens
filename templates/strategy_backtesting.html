<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLens - Strategy Backtesting</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .strategy-card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .strategy-card-header {
            background: linear-gradient(90deg, #4d7ae0 0%, #7691e8 100%);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            align-items: center;
        }
        
        .strategy-card-body {
            padding: 20px;
            background-color: #fff;
        }
        
        .portfolio-summary {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #e9ecef;
        }
        
        .portfolio-data {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .portfolio-item {
            flex: 0 0 48%;
            margin-bottom: 10px;
        }
        
        .stock-exposure {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stock-exposure:last-child {
            border-bottom: none;
        }
        
        .stock-symbol {
            font-weight: 600;
        }
        
        .exposure-value {
            font-weight: 500;
        }
        
        .backtesting-presets {
            margin-bottom: 30px;
        }
        
        .preset-dropdown {
            margin-bottom: 20px;
        }
        
        .preset-dropdown .btn {
            width: 100%;
            text-align: left;
            position: relative;
            padding-right: 30px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .preset-dropdown .btn::after {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .preset-dropdown .dropdown-menu {
            width: 100%;
        }
        
        .preset-dropdown .dropdown-item {
            white-space: normal;
            padding: 10px 15px;
        }
        
        .backtesting-results {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .backtesting-results h5 {
            margin-bottom: 15px;
        }
        
        /* Analysis Results Section Styles */
        .analysis-results-section {
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .analysis-results-section .card-header {
            background: linear-gradient(90deg, #4d7ae0 0%, #7691e8 100%);
            font-weight: 600;
        }
        
        .analysis-result {
            padding: 15px 0;
            line-height: 1.6;
        }
        
        .analysis-result p {
            margin-bottom: 12px;
        }
        
        .analysis-result ul, .analysis-result ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }
        
        .analysis-result li {
            margin-bottom: 8px;
        }
        
        .analysis-result h1, .analysis-result h2, .analysis-result h3 {
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .analysis-result table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }
        
        .analysis-result table, .analysis-result th, .analysis-result td {
            border: 1px solid #dee2e6;
        }
        
        .analysis-result th, .analysis-result td {
            padding: 8px 12px;
            text-align: left;
        }
        
        .analysis-result th {
            background-color: #f8f9fa;
        }
        
        #results-loading {
            min-height: 200px;
        }
        
        /* Stock Chart Loader Styles */
        .stock-chart-loader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 8px;
            background-color: #f8f9fa;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        /* Line and area chart animations */
        .chart-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 3s ease-in-out forwards;
        }
        
        .main-line, .benchmark-line, .area-chart {
            transition: all 1s ease;
        }
        
        .area-chart {
            opacity: 0;
            animation: fadeIn 2s ease-in forwards;
        }
        
        /* Candlestick animations */
        .candlestick {
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }
        
        .candlestick.wick {
            transform-origin: center center;
            animation: fadeIn 0.5s ease-in forwards, stretchy 0.5s ease-out forwards;
        }
        
        /* Volume bars animation */
        .volume-bar {
            opacity: 0;
            transform: scaleY(0);
            transform-origin: bottom;
            animation: growUp 0.4s ease-out forwards;
        }
        
        /* Data points animation */
        .data-point {
            opacity: 0;
            transform: scale(0);
            animation: fadeInPoint 0.8s ease-out forwards;
            transition: all 0.5s ease;
        }
        
        @keyframes fadeInPoint {
            0% { 
                opacity: 0;
                transform: scale(0);
            }
            100% { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Event markers animation */
        .event-marker {
            opacity: 0;
            stroke-dashoffset: 100;
            animation: fadeIn 0.5s ease-in forwards, dashIn 1s ease-out forwards;
        }
        
        .event-label {
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }
        
        /* Focus tracking elements */
        .tracking-line {
            transition: all 0.3s ease;
        }
        
        /* Chart title pulse animation */
        .chart-title {
            animation: subtle-pulse 3s infinite alternate;
        }
        
        /* Indicator text animation */
        .indicator-text {
            transition: all 0.3s ease;
        }
        
        /* Animation keyframes */
        @keyframes dash {
            0% {
                stroke-dashoffset: 1000;
            }
            100% {
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes dashIn {
            from { stroke-dashoffset: 100; }
            to { stroke-dashoffset: 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes popIn {
            0% { 
                opacity: 0;
                transform: scale(0);
            }
            70% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes growUp {
            from { 
                opacity: 0;
                transform: scaleY(0);
            }
            to { 
                opacity: 0.5;
                transform: scaleY(1);
            }
        }
        
        @keyframes stretchy {
            0% { transform: scaleY(0.7); }
            50% { transform: scaleY(1.1); }
            100% { transform: scaleY(1); }
        }
        
        @keyframes subtle-pulse {
            from { opacity: 0.85; }
            to { opacity: 1; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stock-chart-loader svg {
                height: 250px;
            }
        }
        
        /* Chart grid styling */
        .chart-grid line {
            stroke-dasharray: 4;
        }
    </style>
</head>
<body>
    <div class="orglens-layout">
        {% include 'sidebar.html' %}
        
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <h1 class="mb-4">Strategy Backtesting</h1>
            
            <!-- Portfolio Summary Section -->
            <div class="portfolio-summary">
                <h4>Current Portfolio Composition</h4>
                <div class="portfolio-data">
                    {% if portfolio %}
                        <!-- Top Holdings Display -->
                        <div class="portfolio-item">
                            <h5>Top Holdings</h5>
                            {% for stock in portfolio[:5] %}
                                <div class="stock-exposure">
                                    <div>
                                        <span class="stock-symbol">{{ stock.Symbol }}</span>
                                        <span class="text-muted ml-2">{{ stock.Name }}</span>
                                    </div>
                                    <div class="exposure-value">
                                        {% if stock.Symbol in current_prices and current_prices[stock.Symbol] %}
                                            ${{ "%.2f"|format(current_prices[stock.Symbol]) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Portfolio Stats -->
                        <div class="portfolio-item">
                            <h5>Stocks for Analysis</h5>
                            <p class="text-muted mb-2">Select any of the presets below to analyze market events and their impact on your portfolio stocks.</p>
                            <div class="stock-exposure">
                                <div>Total Holdings</div>
                                <div class="exposure-value">{{ portfolio|length }} stocks</div>
                            </div>
                            <div class="stock-exposure">
                                <div>Analysis Date</div>
                                <div class="exposure-value">{{ analysis_date }}</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info w-100">
                            No current holdings found in your portfolio. Upload your transaction data to analyze potential strategies.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Backtesting Strategy Section -->
            <div class="strategy-card">
                <div class="strategy-card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-graph-up mr-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z"/>
                    </svg>
                    Strategy Backtesting Analysis
                </div>
                <div class="strategy-card-body">
                    <h5>Historical Context Analysis</h5>
                    <p>Select a pre-defined analysis scenario or enter your own query to understand how market events affected various strategies and sectors.</p>
                    
                    <div class="backtesting-presets">
                        <div class="preset-dropdown">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="presetDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select an Analysis Preset
                                </button>
                                <div class="dropdown-menu" aria-labelledby="presetDropdown">
                                    {% for preset in backtesting_presets %}
                                        <a class="dropdown-item preset-item" href="#" data-preset-id="{{ preset.id }}" data-preset-prompt="{{ preset.prompt }}">
                                            {{ preset.name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="customPrompt">Or enter your own analysis query:</label>
                            <textarea class="form-control" id="customPrompt" rows="3" placeholder="E.g., Analyze how rising inflation impacted growth stocks in 2021-2022..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" id="runBacktestBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill mr-1" viewBox="0 0 16 16">
                                <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                            </svg>
                            Run Analysis
                        </button>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" value="" id="annotateBacktestCheck" checked>
                            <label class="form-check-label" for="annotateBacktestCheck">
                                Annotate backtest period with historical news context to explain anomalies
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Results Section -->
            <div id="analysis-results" class="analysis-results-section mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="results-content" class="results-content">
                            <div class="text-center py-5" id="results-loading" style="display: none;">
                                <div class="stock-chart-loader">
                                    <svg width="100%" height="300" viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Background and chart frame -->
                                        <rect x="0" y="0" width="600" height="300" fill="#f8f9fa" rx="8" ry="8"></rect>
                                        <rect x="10" y="10" width="580" height="230" fill="#ffffff" stroke="#e9ecef" stroke-width="1" rx="4" ry="4"></rect>
                                        
                                        <!-- Title area -->
                                        <text x="20" y="30" fill="#333" font-size="14" font-weight="bold" class="chart-title">Market Backtest Analysis</text>
                                        
                                        <!-- Chart grid -->
                                        <g class="chart-grid">
                                            <line x1="50" y1="60" x2="550" y2="60" stroke="#eee" stroke-width="1" />
                                            <line x1="50" y1="100" x2="550" y2="100" stroke="#eee" stroke-width="1" />
                                            <line x1="50" y1="140" x2="550" y2="140" stroke="#eee" stroke-width="1" />
                                            <line x1="50" y1="180" x2="550" y2="180" stroke="#eee" stroke-width="1" />
                                            <line x1="50" y1="220" x2="550" y2="220" stroke="#eee" stroke-width="1" />
                                            
                                            <line x1="50" y1="60" x2="50" y2="220" stroke="#eee" stroke-width="1" />
                                            <line x1="130" y1="60" x2="130" y2="220" stroke="#eee" stroke-width="1" />
                                            <line x1="210" y1="60" x2="210" y2="220" stroke="#eee" stroke-width="1" />
                                            <line x1="290" y1="60" x2="290" y2="220" stroke="#eee" stroke-width="1" />
                                            <line x1="370" y1="60" x2="370" y2="220" stroke="#eee" stroke-width="1" />
                                            <line x1="450" y1="60" x2="450" y2="220" stroke="#eee" stroke-width="1" />
                                            <line x1="530" y1="60" x2="530" y2="220" stroke="#eee" stroke-width="1" />
                                        </g>
                                        
                                        <!-- Y-axis labels -->
                                        <text x="30" y="65" fill="#888" font-size="10" text-anchor="end">100%</text>
                                        <text x="30" y="105" fill="#888" font-size="10" text-anchor="end">75%</text>
                                        <text x="30" y="145" fill="#888" font-size="10" text-anchor="end">50%</text>
                                        <text x="30" y="185" fill="#888" font-size="10" text-anchor="end">25%</text>
                                        <text x="30" y="225" fill="#888" font-size="10" text-anchor="end">0%</text>
                                        
                                        <!-- X-axis labels -->
                                        <text x="50" y="240" fill="#888" font-size="10" text-anchor="middle">Jan</text>
                                        <text x="130" y="240" fill="#888" font-size="10" text-anchor="middle">Feb</text>
                                        <text x="210" y="240" fill="#888" font-size="10" text-anchor="middle">Mar</text>
                                        <text x="290" y="240" fill="#888" font-size="10" text-anchor="middle">Apr</text>
                                        <text x="370" y="240" fill="#888" font-size="10" text-anchor="middle">May</text>
                                        <text x="450" y="240" fill="#888" font-size="10" text-anchor="middle">Jun</text>
                                        <text x="530" y="240" fill="#888" font-size="10" text-anchor="middle">Jul</text>
                                        
                                        <!-- Area Chart (for market indices) -->
                                        <defs>
                                            <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                                <stop offset="0%" stop-color="rgba(77, 122, 224, 0.8)" />
                                                <stop offset="100%" stop-color="rgba(77, 122, 224, 0.1)" />
                                            </linearGradient>
                                        </defs>
                                        <path class="area-chart" d="M50,220 L50,220" fill="url(#areaGradient)" stroke="none" />
                                        
                                        <!-- Main line (strategy performance) -->
                                        <path class="main-line" d="M50,140 L50,140" stroke="#4d7ae0" stroke-width="3" fill="none" />
                                        
                                        <!-- Secondary line (benchmark) -->
                                        <path class="benchmark-line" d="M50,140 L50,140" stroke="#ff9800" stroke-width="2" fill="none" stroke-dasharray="5,3" />
                                        
                                        <!-- Candlesticks container -->
                                        <g class="candlesticks"></g>
                                        
                                        <!-- Data points -->
                                        <g class="data-points"></g>
                                        
                                        <!-- Volume bars container -->
                                        <g class="volume-bars"></g>
                                        
                                        <!-- Legend -->
                                        <rect x="400" y="15" width="12" height="6" fill="#4d7ae0" rx="1" ry="1"></rect>
                                        <text x="420" y="21" fill="#333" font-size="10">Strategy</text>
                                        
                                        <rect x="470" y="15" width="12" height="6" fill="#ff9800" rx="1" ry="1"></rect>
                                        <text x="490" y="21" fill="#333" font-size="10">Benchmark</text>
                                        
                                        <!-- Event markers -->
                                        <g class="event-markers"></g>
                                        
                                        <!-- Focus tracking line (vertical) -->
                                        <line class="tracking-line" x1="0" y1="0" x2="0" y2="0" stroke="#999" stroke-width="1" stroke-dasharray="3,2" opacity="0" />
                                        
                                        <!-- Indicator panel -->
                                        <rect x="10" y="250" width="580" height="40" fill="#f8f9fa" stroke="#e9ecef" stroke-width="1" rx="4" ry="4"></rect>
                                        <g class="indicators">
                                            <text x="20" y="275" fill="#333" font-size="12" font-weight="bold">Analyzing:</text>
                                            <text x="100" y="275" fill="#555" font-size="12" class="indicator-text">Processing market data...</text>
                                        </g>
                                    </svg>
                                </div>
                                <p class="mt-3">Analyzing historical market data and generating investment insights...</p>
                            </div>
                            <div id="results-data"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Integration Section -->
            <div class="mt-5">
                <h4>Analyze Market Context and Strategy Performance</h4>
                <p>Our AI assistant can help you understand market events and their impact on different investment strategies.</p>
                <div class="chat-prompt-link">
                    <a href="#" class="btn btn-outline-primary" id="backtest-analysis-btn" data-chat-prompt="Annotate backtest period with historical news context to explain anomalies">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots mr-2" viewBox="0 0 16 16">
                            <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2"/>
                        </svg>
                        Analyze Historical Market Context
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the chat component -->
    {% include 'chat_component.html' %}

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="{{ url_for('static', filename='js/chat-integration.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    
    <!-- Add script to handle strategy backtesting interactions -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Strategy backtesting page loaded');
            
            // Stock chart loader animation
            function initChartLoaderAnimation() {
                // Generate random paths for the lines
                const generateRandomPath = (baseline, volatility, trend = 0) => {
                    // Starting point
                    let path = `M50,${baseline} `;
                    const points = 30;
                    const maxPoint = 550; // End X coordinate
                    
                    let lastY = baseline;
                    
                    // Create a smooth curve with random points
                    for (let i = 1; i <= points; i++) {
                        const x = 50 + (i / points) * (maxPoint - 50);
                        
                        // Add some randomness but maintain a trend
                        const randomFactor = (Math.random() - 0.5) * volatility;
                        const trendFactor = trend * (i / points);
                        
                        // Generate y with constraints to keep line within bounds
                        let y = lastY + randomFactor + trendFactor;
                        y = Math.max(60, Math.min(220, y)); // Keep within chart bounds
                        
                        path += `L${x},${y} `;
                        lastY = y;
                    }
                    return path.trim();
                };
                
                // Generate area chart path (adds bottom line to close the path)
                const generateAreaPath = (linePath) => {
                    // Extract the start and end points of the line path
                    const matches = linePath.match(/M(\d+),(\d+)/) || [];
                    const startX = matches[1] || 50;
                    
                    // Add bottom line to close the area
                    return `${linePath} L550,220 L${startX},220 Z`;
                };
                
                // Generate volume bars
                const generateVolumeBars = () => {
                    const volumeGroup = document.querySelector('.volume-bars');
                    if (!volumeGroup) return;
                    
                    // Clear existing bars
                    volumeGroup.innerHTML = '';
                    
                    // Number of bars
                    const barCount = 24;
                    const barWidth = 7;
                    const spacing = 20;
                    
                    // Generate volume bars with animation delay
                    for (let i = 0; i < barCount; i++) {
                        const x = 60 + (i * spacing);
                        const height = Math.random() * 25 + 5; // Random height 5-30
                        const y = 220 - height;
                        
                        const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        bar.setAttribute('x', x);
                        bar.setAttribute('y', y);
                        bar.setAttribute('width', barWidth);
                        bar.setAttribute('height', height);
                        bar.setAttribute('fill', '#a0c4ff');
                        bar.setAttribute('opacity', '0.5');
                        bar.classList.add('volume-bar');
                        bar.style.animationDelay = `${i * 0.05}s`;
                        
                        volumeGroup.appendChild(bar);
                    }
                };
                
                // Generate candlesticks
                const generateCandlesticks = () => {
                    const candlestickGroup = document.querySelector('.candlesticks');
                    if (!candlestickGroup) return;
                    
                    // Clear existing candlesticks
                    candlestickGroup.innerHTML = '';
                    
                    // Generate candlesticks
                    for (let i = 0; i < 12; i++) {
                        const x = 75 + (i * 40);
                        const height = Math.random() * 30 + 10; // Random height 10-40
                        const isUp = Math.random() > 0.4; // Bullish bias for visualization
                        
                        // Calculate candlestick values
                        const open = 120 + (Math.random() - 0.5) * 60; // Middle of chart with randomness
                        const close = isUp ? open - height : open + height;
                        const high = Math.min(open, close) - (Math.random() * 10);
                        const low = Math.max(open, close) + (Math.random() * 10);
                        
                        // Create wick (vertical line)
                        const wick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        wick.setAttribute('x1', x);
                        wick.setAttribute('y1', high);
                        wick.setAttribute('x2', x);
                        wick.setAttribute('y2', low);
                        wick.setAttribute('stroke', isUp ? '#4CAF50' : '#F44336');
                        wick.setAttribute('stroke-width', '1');
                        wick.classList.add('candlestick', 'wick');
                        wick.style.animationDelay = `${i * 0.1}s`;
                        
                        // Create body (rectangle)
                        const body = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        body.setAttribute('x', x - 5);
                        body.setAttribute('y', Math.min(open, close));
                        body.setAttribute('width', '10');
                        body.setAttribute('height', Math.abs(close - open));
                        body.setAttribute('fill', isUp ? '#4CAF50' : '#F44336');
                        body.classList.add('candlestick', 'body');
                        body.style.animationDelay = `${i * 0.1 + 0.05}s`;
                        
                        candlestickGroup.appendChild(wick);
                        candlestickGroup.appendChild(body);
                    }
                };
                
                // Add data points to chart lines
                const addDataPoints = () => {
                    const dataPointsGroup = document.querySelector('.data-points');
                    if (!dataPointsGroup) return;
                    
                    // Fade out existing points before removing them
                    const existingPoints = dataPointsGroup.querySelectorAll('.data-point');
                    existingPoints.forEach(point => {
                        point.style.opacity = '0';
                        point.style.transform = 'scale(0.5)';
                    });
                    
                    // Delay creating new points to allow fade out animation
                    setTimeout(() => {
                        // Clear existing points
                        dataPointsGroup.innerHTML = '';
                        
                        // Get current path for main-line
                        const mainLine = document.querySelector('.main-line');
                        if (!mainLine) return;
                        
                        const pathData = mainLine.getAttribute('d');
                        const points = pathData.split(' ')
                            .filter(p => p.includes(','))
                            .map(p => {
                                const coords = p.substring(1).split(',');
                                return { x: parseFloat(coords[0]), y: parseFloat(coords[1]) };
                            });
                        
                        // Select only specific points at regular intervals (fewer points)
                        // and use larger intervals to avoid crowded appearance
                        const selectedPoints = [];
                        for (let i = 0; i < points.length; i += 6) {  // Increased interval
                            if (i < points.length) {
                                selectedPoints.push(points[i]);
                            }
                        }
                        
                        // Add data points with sequential delays for more controlled appearance
                        selectedPoints.forEach((point, i) => {
                            const delay = i * 0.3; // Slower sequential delay
                            
                            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            circle.setAttribute('cx', point.x);
                            circle.setAttribute('cy', point.y);
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#4d7ae0');
                            circle.setAttribute('stroke', '#ffffff');
                            circle.setAttribute('stroke-width', '1.5');
                            circle.classList.add('data-point');
                            circle.style.animationDelay = `${delay}s`;
                            
                            dataPointsGroup.appendChild(circle);
                        });
                    }, 500); // Wait for fade out animation
                };
                
                // Add event markers (important market events)
                const addEventMarkers = () => {
                    const eventMarkersGroup = document.querySelector('.event-markers');
                    if (!eventMarkersGroup) return;
                    
                    // Clear existing markers
                    eventMarkersGroup.innerHTML = '';
                    
                    // Add a few event markers at different positions
                    const events = [
                        { x: 130, label: 'Fed Decision' },
                        { x: 290, label: 'Earnings' },
                        { x: 450, label: 'Market Event' }
                    ];
                    
                    events.forEach((event, i) => {
                        // Create vertical marker line
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', event.x);
                        line.setAttribute('y1', 60);
                        line.setAttribute('x2', event.x);
                        line.setAttribute('y2', 220);
                        line.setAttribute('stroke', '#ff5722');
                        line.setAttribute('stroke-width', '1');
                        line.setAttribute('stroke-dasharray', '3,3');
                        line.classList.add('event-marker');
                        line.style.animationDelay = `${1 + i * 0.5}s`;
                        
                        // Create event label
                        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        label.setAttribute('x', event.x);
                        label.setAttribute('y', 50);
                        label.setAttribute('fill', '#ff5722');
                        label.setAttribute('font-size', '8');
                        label.setAttribute('text-anchor', 'middle');
                        label.textContent = event.label;
                        label.classList.add('event-label');
                        label.style.animationDelay = `${1.2 + i * 0.5}s`;
                        
                        eventMarkersGroup.appendChild(line);
                        eventMarkersGroup.appendChild(label);
                    });
                };
                
                // Update indicator text with simulated analysis stages
                const updateIndicatorText = () => {
                    const indicatorText = document.querySelector('.indicator-text');
                    if (!indicatorText) return;
                    
                    const stages = [
                        'Loading market data...',
                        'Analyzing price patterns...',
                        'Calculating technical indicators...',
                        'Running regression analysis...',
                        'Simulating trading strategies...',
                        'Evaluating market conditions...',
                        'Generating predictions...',
                        'Computing risk metrics...'
                    ];
                    
                    let currentIndex = 0;
                    
                    const updateText = () => {
                        indicatorText.textContent = stages[currentIndex];
                        currentIndex = (currentIndex + 1) % stages.length;
                    };
                    
                    // Update immediately then set interval
                    updateText();
                    return setInterval(updateText, 2000);
                };
                
                // Initialize and animate all chart elements
                const initializeChart = () => {
                    // Get chart elements
                    const mainLine = document.querySelector('.main-line');
                    const benchmarkLine = document.querySelector('.benchmark-line');
                    const areaChart = document.querySelector('.area-chart');
                    
                    // Generate random paths for strategy and benchmark
                    const mainPath = generateRandomPath(140, 20, -40); // Trending downward slightly
                    const benchmarkPath = generateRandomPath(140, 15, -25); // Less volatile
                    
                    // Set paths for lines
                    if (mainLine) mainLine.setAttribute('d', mainPath);
                    if (benchmarkLine) benchmarkLine.setAttribute('d', benchmarkPath);
                    
                    // Set path for area chart
                    if (areaChart) {
                        const areaPath = generateAreaPath(mainPath);
                        areaChart.setAttribute('d', areaPath);
                    }
                    
                    // Generate and add other chart elements
                    generateVolumeBars();
                    generateCandlesticks();
                    addDataPoints();
                    addEventMarkers();
                    
                    // Initialize indicator text updates
                    const textInterval = updateIndicatorText();
                    
                    // Return interval reference for cleanup
                    return textInterval;
                };
                
                // Start animation
                const textInterval = initializeChart();
                
                // Update the chart periodically
                const chartInterval = setInterval(() => {
                    // Generate new random paths
                    const mainPath = generateRandomPath(140, 20, -40);
                    const benchmarkPath = generateRandomPath(140, 15, -25);
                    
                    // Update main line with animation
                    const mainLine = document.querySelector('.main-line');
                    if (mainLine) {
                        mainLine.style.transition = 'all 1s ease';
                        mainLine.setAttribute('d', mainPath);
                    }
                    
                    // Update benchmark line with animation
                    const benchmarkLine = document.querySelector('.benchmark-line');
                    if (benchmarkLine) {
                        benchmarkLine.style.transition = 'all 1s ease';
                        benchmarkLine.setAttribute('d', benchmarkPath);
                    }
                    
                    // Update area chart
                    const areaChart = document.querySelector('.area-chart');
                    if (areaChart) {
                        areaChart.style.transition = 'all 1s ease';
                        const areaPath = generateAreaPath(mainPath);
                        areaChart.setAttribute('d', areaPath);
                    }
                    
                    // Static counter to track updates for less frequent data point refreshes
                    chartInterval.updateCount = (chartInterval.updateCount || 0) + 1;
                    
                    // Refresh candlesticks and volume bars on every update
                    setTimeout(() => {
                        generateCandlesticks();
                        generateVolumeBars();
                        
                        // Only update data points every 3rd refresh to avoid too many flying dots
                        if (chartInterval.updateCount % 3 === 0) {
                            addDataPoints();
                        }
                    }, 1000);
                    
                }, 8000); // Update every 8 seconds
                
                // Return cleanup function to clear intervals when component is destroyed
                return () => {
                    clearInterval(chartInterval);
                    clearInterval(textInterval);
                };
            }
            
            // Get the UI elements
            const presetDropdown = document.getElementById('presetDropdown');
            const presetItems = document.querySelectorAll('.preset-item');
            const customPrompt = document.getElementById('customPrompt');
            const runBacktestBtn = document.getElementById('runBacktestBtn');
            const annotateCheck = document.getElementById('annotateBacktestCheck');
            const backtestBtn = document.getElementById('backtest-analysis-btn');
            
            // Keep track of the selected preset
            let selectedPreset = null;
            let selectedPresetPrompt = "";
            
            // Handle preset selection
            presetItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update dropdown button text
                    presetDropdown.textContent = this.textContent.trim();
                    
                    // Store selected preset info
                    selectedPreset = this.getAttribute('data-preset-id');
                    selectedPresetPrompt = this.getAttribute('data-preset-prompt');
                    
                    // Clear custom prompt
                    customPrompt.value = '';
                });
            });
            
            // Handle running the backtest
            runBacktestBtn.addEventListener('click', function() {
                // Get the prompt to send
                let prompt = "";
                
                if (customPrompt.value.trim()) {
                    // Use custom prompt if provided
                    prompt = customPrompt.value.trim();
                } else if (selectedPresetPrompt) {
                    // Otherwise use selected preset prompt
                    prompt = selectedPresetPrompt;
                } else {
                    // No prompt selected
                    alert("Please select a preset or enter a custom query first.");
                    return;
                }
                
                // Add annotation context if checkbox is checked
                if (annotateCheck.checked) {
                    prompt += " Annotate backtest period with historical news context to explain anomalies.";
                }
                
                // Show the analysis results section and loading indicator
                const analysisResults = document.getElementById('analysis-results');
                const resultsLoading = document.getElementById('results-loading');
                const resultsData = document.getElementById('results-data');
                
                if (!analysisResults || !resultsLoading || !resultsData) {
                    console.error('Analysis results elements not found');
                    alert("Couldn't find the analysis results container. Please try refreshing the page.");
                    return;
                }
                
                // Display the results section and loading indicator
                analysisResults.style.display = 'block';
                resultsLoading.style.display = 'block';
                resultsData.innerHTML = '';
                
                // Initialize the chart loader animation
                initChartLoaderAnimation();
                
                // Scroll to the results section
                analysisResults.scrollIntoView({ behavior: 'smooth' });
                
                // Make sure the chat container stays collapsed
                const chatContainer = document.querySelector('.chat-bot-container');
                if (chatContainer && !chatContainer.classList.contains('collapsed')) {
                    chatContainer.classList.add('collapsed');
                }
                
                // Make API call directly
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: prompt,
                        stock: null,
                        source: 'strategy_backtesting'
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading indicator
                    resultsLoading.style.display = 'none';
                    
                    // Display results
                    if (data.response) {
                        // Parse markdown response with marked.js
                        const formattedResponse = marked.parse(data.response);
                        
                        // Add AI provider information
                        let providerInfo = '';
                        if (data.provider) {
                            providerInfo = `<div class="text-muted mt-3">
                                <small>Analysis provided by ${data.provider}${data.model ? ` - ${data.model}` : ''}</small>
                            </div>`;
                        }
                        
                        // Update results container
                        resultsData.innerHTML = `
                            <div class="analysis-result">
                                ${formattedResponse}
                                ${providerInfo}
                            </div>
                        `;
                    } else {
                        resultsData.innerHTML = `
                            <div class="alert alert-warning">
                                Sorry, I couldn't process your analysis request. Please try again.
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching analysis:', error);
                    resultsLoading.style.display = 'none';
                    resultsData.innerHTML = `
                        <div class="alert alert-danger">
                            Error: Unable to complete the analysis. Please try again later.
                        </div>
                    `;
                });
            });
            
            // Handle backtest analysis button
            if (backtestBtn) {
                backtestBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Ensure chat is visible
                    const chatContainer = document.querySelector('.chat-bot-container');
                    if (chatContainer && chatContainer.classList.contains('collapsed')) {
                        chatContainer.classList.remove('collapsed');
                    }
                    
                    // Get prompt from data attribute
                    const prompt = this.getAttribute('data-chat-prompt');
                    if (!prompt) return;
                    
                    // First, immediately add the user message to the chat
                    if (window.TradeLensChat && typeof window.TradeLensChat.addMessage === 'function') {
                        // Add user message right away
                        window.TradeLensChat.addMessage('user', prompt);
                        
                        // Add typing indicator
                        const chatMessages = document.querySelector('.chat-bot-messages');
                        const typingIndicator = document.createElement('div');
                        typingIndicator.classList.add('chat-bot-message', 'bot', 'typing');
                        typingIndicator.innerHTML = '<div class="chat-bot-message-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
                        
                        if (chatMessages) {
                            chatMessages.appendChild(typingIndicator);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        
                        // Disable the input field while waiting for the response
                        const chatInput = document.querySelector('.chat-bot-input');
                        const sendButton = document.querySelector('.chat-bot-send');
                        if (chatInput) chatInput.disabled = true;
                        if (sendButton) sendButton.disabled = true;
                        
                        // Make the API call
                        fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: prompt,
                                stock: null,
                                source: 'strategy_backtesting'
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Remove typing indicator
                            if (chatMessages && typingIndicator && typingIndicator.parentNode) {
                                chatMessages.removeChild(typingIndicator);
                            }
                            
                            // Add response if available
                            if (data.response) {
                                // Parse markdown response with marked.js
                                const formattedResponse = marked.parse(data.response);
                                
                                // Add the bot message
                                window.TradeLensChat.addMessage('bot', formattedResponse, 
                                    data.provider ? (data.provider + (data.model ? ` - ${data.model}` : '')) : 'TradeLens AI');
                            } else {
                                window.TradeLensChat.addMessage('bot', 'Sorry, I couldn\'t process your request.');
                            }
                            
                            // Re-enable the input field
                            if (chatInput) chatInput.disabled = false;
                            if (sendButton) sendButton.disabled = false;
                            if (chatInput) chatInput.focus();
                        })
                        .catch(error => {
                            console.error('Error fetching chat response:', error);
                            
                            // Remove typing indicator
                            if (chatMessages && typingIndicator && typingIndicator.parentNode) {
                                chatMessages.removeChild(typingIndicator);
                            }
                            
                            // Add error message
                            window.TradeLensChat.addMessage('bot', 'Sorry, there was an error processing your request. Please try again.');
                            
                            // Re-enable the input field
                            if (chatInput) chatInput.disabled = false;
                            if (sendButton) sendButton.disabled = false;
                        });
                    }
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
</body>
</html>