<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLens - Strategy Backtesting</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .strategy-card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .strategy-card-header {
            background: linear-gradient(90deg, #4d7ae0 0%, #7691e8 100%);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            align-items: center;
        }
        
        .strategy-card-body {
            padding: 20px;
            background-color: #fff;
        }
        
        .portfolio-summary {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #e9ecef;
        }
        
        .portfolio-data {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .portfolio-item {
            flex: 0 0 48%;
            margin-bottom: 10px;
        }
        
        .stock-exposure {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stock-exposure:last-child {
            border-bottom: none;
        }
        
        .stock-symbol {
            font-weight: 600;
        }
        
        .exposure-value {
            font-weight: 500;
        }
        
        .backtesting-presets {
            margin-bottom: 30px;
        }
        
        .preset-dropdown {
            margin-bottom: 20px;
        }
        
        .preset-dropdown .btn {
            width: 100%;
            text-align: left;
            position: relative;
            padding-right: 30px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .preset-dropdown .btn::after {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .preset-dropdown .dropdown-menu {
            width: 100%;
        }
        
        .preset-dropdown .dropdown-item {
            white-space: normal;
            padding: 10px 15px;
        }
        
        .backtesting-results {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .backtesting-results h5 {
            margin-bottom: 15px;
        }
        
        /* Analysis Results Section Styles */
        .analysis-results-section {
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .analysis-results-section .card-header {
            background: linear-gradient(90deg, #4d7ae0 0%, #7691e8 100%);
            font-weight: 600;
        }
        
        .analysis-result {
            padding: 15px 0;
            line-height: 1.6;
        }
        
        .analysis-result p {
            margin-bottom: 12px;
        }
        
        .analysis-result ul, .analysis-result ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }
        
        .analysis-result li {
            margin-bottom: 8px;
        }
        
        .analysis-result h1, .analysis-result h2, .analysis-result h3 {
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .analysis-result table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }
        
        .analysis-result table, .analysis-result th, .analysis-result td {
            border: 1px solid #dee2e6;
        }
        
        .analysis-result th, .analysis-result td {
            padding: 8px 12px;
            text-align: left;
        }
        
        .analysis-result th {
            background-color: #f8f9fa;
        }
        
        #results-loading {
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="orglens-layout">
        {% include 'sidebar.html' %}
        
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <h1 class="mb-4">Strategy Backtesting</h1>
            
            <!-- Portfolio Summary Section -->
            <div class="portfolio-summary">
                <h4>Current Portfolio Composition</h4>
                <div class="portfolio-data">
                    {% if portfolio %}
                        <!-- Top Holdings Display -->
                        <div class="portfolio-item">
                            <h5>Top Holdings</h5>
                            {% for stock in portfolio[:5] %}
                                <div class="stock-exposure">
                                    <div>
                                        <span class="stock-symbol">{{ stock.Symbol }}</span>
                                        <span class="text-muted ml-2">{{ stock.Name }}</span>
                                    </div>
                                    <div class="exposure-value">
                                        {% if stock.Symbol in current_prices and current_prices[stock.Symbol] %}
                                            ${{ "%.2f"|format(current_prices[stock.Symbol]) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Portfolio Stats -->
                        <div class="portfolio-item">
                            <h5>Stocks for Analysis</h5>
                            <p class="text-muted mb-2">Select any of the presets below to analyze market events and their impact on your portfolio stocks.</p>
                            <div class="stock-exposure">
                                <div>Total Holdings</div>
                                <div class="exposure-value">{{ portfolio|length }} stocks</div>
                            </div>
                            <div class="stock-exposure">
                                <div>Analysis Date</div>
                                <div class="exposure-value">{{ analysis_date }}</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info w-100">
                            No current holdings found in your portfolio. Upload your transaction data to analyze potential strategies.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Backtesting Strategy Section -->
            <div class="strategy-card">
                <div class="strategy-card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-graph-up mr-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z"/>
                    </svg>
                    Strategy Backtesting Analysis
                </div>
                <div class="strategy-card-body">
                    <h5>Historical Context Analysis</h5>
                    <p>Select a pre-defined analysis scenario or enter your own query to understand how market events affected various strategies and sectors.</p>
                    
                    <div class="backtesting-presets">
                        <div class="preset-dropdown">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="presetDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select an Analysis Preset
                                </button>
                                <div class="dropdown-menu" aria-labelledby="presetDropdown">
                                    {% for preset in backtesting_presets %}
                                        <a class="dropdown-item preset-item" href="#" data-preset-id="{{ preset.id }}" data-preset-prompt="{{ preset.prompt }}">
                                            {{ preset.name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="customPrompt">Or enter your own analysis query:</label>
                            <textarea class="form-control" id="customPrompt" rows="3" placeholder="E.g., Analyze how rising inflation impacted growth stocks in 2021-2022..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" id="runBacktestBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill mr-1" viewBox="0 0 16 16">
                                <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                            </svg>
                            Run Analysis
                        </button>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" value="" id="annotateBacktestCheck" checked>
                            <label class="form-check-label" for="annotateBacktestCheck">
                                Annotate backtest period with historical news context to explain anomalies
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Results Section -->
            <div id="analysis-results" class="analysis-results-section mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="results-content" class="results-content">
                            <div class="text-center py-5" id="results-loading" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-3">Analyzing market data and generating insights...</p>
                            </div>
                            <div id="results-data"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Integration Section -->
            <div class="mt-5">
                <h4>Analyze Market Context and Strategy Performance</h4>
                <p>Our AI assistant can help you understand market events and their impact on different investment strategies.</p>
                <div class="chat-prompt-link">
                    <a href="#" class="btn btn-outline-primary" id="backtest-analysis-btn" data-chat-prompt="Annotate backtest period with historical news context to explain anomalies">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots mr-2" viewBox="0 0 16 16">
                            <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2"/>
                        </svg>
                        Analyze Historical Market Context
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the chat component -->
    {% include 'chat_component.html' %}

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="{{ url_for('static', filename='js/chat-integration.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    
    <!-- Add script to handle strategy backtesting interactions -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Strategy backtesting page loaded');
            
            // Get the UI elements
            const presetDropdown = document.getElementById('presetDropdown');
            const presetItems = document.querySelectorAll('.preset-item');
            const customPrompt = document.getElementById('customPrompt');
            const runBacktestBtn = document.getElementById('runBacktestBtn');
            const annotateCheck = document.getElementById('annotateBacktestCheck');
            const backtestBtn = document.getElementById('backtest-analysis-btn');
            
            // Keep track of the selected preset
            let selectedPreset = null;
            let selectedPresetPrompt = "";
            
            // Handle preset selection
            presetItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update dropdown button text
                    presetDropdown.textContent = this.textContent.trim();
                    
                    // Store selected preset info
                    selectedPreset = this.getAttribute('data-preset-id');
                    selectedPresetPrompt = this.getAttribute('data-preset-prompt');
                    
                    // Clear custom prompt
                    customPrompt.value = '';
                });
            });
            
            // Handle running the backtest
            runBacktestBtn.addEventListener('click', function() {
                // Get the prompt to send
                let prompt = "";
                
                if (customPrompt.value.trim()) {
                    // Use custom prompt if provided
                    prompt = customPrompt.value.trim();
                } else if (selectedPresetPrompt) {
                    // Otherwise use selected preset prompt
                    prompt = selectedPresetPrompt;
                } else {
                    // No prompt selected
                    alert("Please select a preset or enter a custom query first.");
                    return;
                }
                
                // Add annotation context if checkbox is checked
                if (annotateCheck.checked) {
                    prompt += " Annotate backtest period with historical news context to explain anomalies.";
                }
                
                // Show the analysis results section and loading indicator
                const analysisResults = document.getElementById('analysis-results');
                const resultsLoading = document.getElementById('results-loading');
                const resultsData = document.getElementById('results-data');
                
                if (!analysisResults || !resultsLoading || !resultsData) {
                    console.error('Analysis results elements not found');
                    alert("Couldn't find the analysis results container. Please try refreshing the page.");
                    return;
                }
                
                // Display the results section and loading indicator
                analysisResults.style.display = 'block';
                resultsLoading.style.display = 'block';
                resultsData.innerHTML = '';
                
                // Scroll to the results section
                analysisResults.scrollIntoView({ behavior: 'smooth' });
                
                // Make sure the chat container stays collapsed
                const chatContainer = document.querySelector('.chat-bot-container');
                if (chatContainer && !chatContainer.classList.contains('collapsed')) {
                    chatContainer.classList.add('collapsed');
                }
                
                // Make API call directly
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: prompt,
                        stock: null
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading indicator
                    resultsLoading.style.display = 'none';
                    
                    // Display results
                    if (data.response) {
                        // Parse markdown response with marked.js
                        const formattedResponse = marked.parse(data.response);
                        
                        // Add AI provider information
                        let providerInfo = '';
                        if (data.provider) {
                            providerInfo = `<div class="text-muted mt-3">
                                <small>Analysis provided by ${data.provider}${data.model ? ` - ${data.model}` : ''}</small>
                            </div>`;
                        }
                        
                        // Update results container
                        resultsData.innerHTML = `
                            <div class="analysis-result">
                                ${formattedResponse}
                                ${providerInfo}
                            </div>
                        `;
                    } else {
                        resultsData.innerHTML = `
                            <div class="alert alert-warning">
                                Sorry, I couldn't process your analysis request. Please try again.
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching analysis:', error);
                    resultsLoading.style.display = 'none';
                    resultsData.innerHTML = `
                        <div class="alert alert-danger">
                            Error: Unable to complete the analysis. Please try again later.
                        </div>
                    `;
                });
            });
            
            // Handle backtest analysis button
            if (backtestBtn) {
                backtestBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Ensure chat is visible
                    const chatContainer = document.querySelector('.chat-bot-container');
                    if (chatContainer && chatContainer.classList.contains('collapsed')) {
                        chatContainer.classList.remove('collapsed');
                    }
                    
                    // Get prompt from data attribute
                    const prompt = this.getAttribute('data-chat-prompt');
                    if (!prompt) return;
                    
                    // First, immediately add the user message to the chat
                    if (window.TradeLensChat && typeof window.TradeLensChat.addMessage === 'function') {
                        // Add user message right away
                        window.TradeLensChat.addMessage('user', prompt);
                        
                        // Add typing indicator
                        const chatMessages = document.querySelector('.chat-bot-messages');
                        const typingIndicator = document.createElement('div');
                        typingIndicator.classList.add('chat-bot-message', 'bot', 'typing');
                        typingIndicator.innerHTML = '<div class="chat-bot-message-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
                        
                        if (chatMessages) {
                            chatMessages.appendChild(typingIndicator);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        
                        // Disable the input field while waiting for the response
                        const chatInput = document.querySelector('.chat-bot-input');
                        const sendButton = document.querySelector('.chat-bot-send');
                        if (chatInput) chatInput.disabled = true;
                        if (sendButton) sendButton.disabled = true;
                        
                        // Make the API call
                        fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: prompt,
                                stock: null
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Remove typing indicator
                            if (chatMessages && typingIndicator && typingIndicator.parentNode) {
                                chatMessages.removeChild(typingIndicator);
                            }
                            
                            // Add response if available
                            if (data.response) {
                                // Parse markdown response with marked.js
                                const formattedResponse = marked.parse(data.response);
                                
                                // Add the bot message
                                window.TradeLensChat.addMessage('bot', formattedResponse, 
                                    data.provider ? (data.provider + (data.model ? ` - ${data.model}` : '')) : null);
                            } else {
                                window.TradeLensChat.addMessage('bot', 'Sorry, I couldn\'t process your request.');
                            }
                            
                            // Re-enable the input field
                            if (chatInput) chatInput.disabled = false;
                            if (sendButton) sendButton.disabled = false;
                            if (chatInput) chatInput.focus();
                        })
                        .catch(error => {
                            console.error('Error fetching chat response:', error);
                            
                            // Remove typing indicator
                            if (chatMessages && typingIndicator && typingIndicator.parentNode) {
                                chatMessages.removeChild(typingIndicator);
                            }
                            
                            // Add error message
                            window.TradeLensChat.addMessage('bot', 'Sorry, there was an error processing your request. Please try again.');
                            
                            // Re-enable the input field
                            if (chatInput) chatInput.disabled = false;
                            if (sendButton) sendButton.disabled = false;
                        });
                    }
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
</body>
</html> 