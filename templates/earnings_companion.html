<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLens - Earnings Companion</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <!-- Showdown.js for Markdown conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
    <style>
        .earnings-card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .earnings-card-header {
            background: linear-gradient(90deg, #4a6cfd 0%, #6e87f5 100%);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .earnings-card-body {
            padding: 20px;
            background-color: #fff;
        }
        
        .portfolio-indicator {
            background-color: #28a745;
            color: white;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            display: inline-block;
        }
        
        .earnings-time {
            background-color: #17a2b8;
            color: white;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            display: inline-block;
        }
        
        .earnings-time.bmo {
            background-color: #fd7e14;
        }
        
        .earnings-time.amc {
            background-color: #6f42c1;
        }
        
        /* Calendar improvements */
        .calendar-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .calendar-week {
            margin-bottom: 2rem;
            background-color: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .calendar-week-header {
            background: linear-gradient(90deg, #4683ea 0%, #65a2ff 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .calendar-week-body {
            padding: 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calendar-weekend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            background-color: #f0f0f0;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calendar-day {
            border-right: 1px solid #dee2e6;
            min-height: 100px;
            padding: 0;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:last-child {
            border-right: none;
        }
        
        .day-header {
            background-color: #e9ecef;
            padding: 10px;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        
        .day-header.today {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .day-header.weekend {
            background-color: #f0f0f0;
            color: #6c757d;
        }
        
        .day-content {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            padding: 5px;
        }
        
        .no-earnings {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        .earnings-item {
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 6px;
            background-color: #f8f9fa;
            border-left: 3px solid #6c757d;
            transition: all 0.2s ease;
        }
        
        .earnings-item:hover {
            background-color: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .earnings-item-portfolio {
            background-color: #f0f7ff;
            border-left: 3px solid #28a745;
        }
        
        .stock-info {
            display: flex;
            align-items: center;
        }
        
        .stock-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: contain;
            background-color: #fff;
            border: 1px solid #e9ecef;
        }
        
        .stock-details {
            display: flex;
            flex-direction: column;
        }
        
        .stock-symbol {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stock-name {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .earnings-metrics {
            font-size: 0.85rem;
            margin-top: 5px;
            color: #495057;
        }
        
        .earnings-actions {
            margin-top: 8px;
            text-align: right;
        }
        
        /* Filter redesign */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-filter {
            display: flex;
            align-items: center;
            background-color: #f0f2f5;
            border-radius: 30px;
            padding: 4px;
        }
        
        .filter-item {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .filter-item.active {
            background-color: #4a6cfd;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-item:not(.active) {
            color: #495057;
        }
        
        .filter-item:hover:not(.active) {
            background-color: #e9ecef;
        }
        
        .calendar-refresh {
            cursor: pointer;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        .calendar-refresh:hover {
            background-color: #e9ecef;
            transform: rotate(15deg);
        }
        
        /* Research section improvements */
        .research-card {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .research-card-header {
            background: linear-gradient(90deg, #6a42c1 0%, #8e6ad1 100%);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            align-items: center;
        }
        
        .research-jobs {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .job-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }
        
        .job-item:hover {
            background-color: #f8f9fa;
        }
        
        .job-item:last-child {
            border-bottom: none;
        }
        
        .job-details {
            display: flex;
            flex-direction: column;
        }
        
        .job-symbol {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .job-date {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .job-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #ffeeba;
            color: #856404;
        }
        
        .status-processing {
            background-color: #b8daff;
            color: #004085;
        }
        
        .status-completed {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-failed {
            background-color: #f5c6cb;
            color: #721c24;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a6cfd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        /* Perplexity banner */
        .ai-attribution {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sources-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        }
        
        .sources-section h2 {
            color: #4a6cfd;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-top: 0 !important;
        }
        
        .source-item {
            padding: 8px 0;
            border-bottom: 1px dashed #e9ecef;
            font-size: 0.9rem;
        }
        
        .source-item:last-child {
            border-bottom: none;
        }
        
        .source-item a {
            color: #4a6cfd;
            text-decoration: none;
        }
        
        .source-item a:hover {
            text-decoration: underline;
        }
        
        /* Improved table styles */
        .markdown-body table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        
        .markdown-body table th,
        .markdown-body table td {
            padding: 12px;
            border: 1px solid #e9ecef;
        }
        
        .markdown-body table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .markdown-body table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        /* Fix for tables without a header row */
        .markdown-body table tr:first-child td {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        /* Fix for empty cells */
        .markdown-body table td:empty:after {
            content: " ";
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="orglens-layout">
        {% include 'sidebar.html' %}
        
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Container for existing content -->
            <div class="container-fluid mb-5">
                <h1 class="mb-4">Earnings Companion</h1>
                
                <div class="container mt-5 mb-5">
                    <div class="row">
                        <!-- Left Column - Calendar -->
                        <div class="col-lg-8">
                            <div class="earnings-card">
                                <div class="earnings-card-header">
                                    <h5 class="mb-0">Upcoming Earnings Calendar</h5>
                                    <span class="badge badge-light">Next 90 Days</span>
                                </div>
                                <div class="earnings-card-body">
                                    <div class="calendar-header">
                                        <div class="calendar-filter">
                                            <div class="filter-item all-filter active" data-filter="all">All</div>
                                            <div class="filter-item portfolio-filter" data-filter="portfolio">Portfolio Only</div>
                                        </div>
                                        <div class="calendar-refresh" id="refreshCalendar" title="Refresh Calendar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                            </svg>
                                            <div class="loading-spinner" id="refreshSpinner"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- AI Attribution Banner -->
                                    <div class="ai-attribution">
                                        <div class="d-flex justify-content-center align-items-center">
                                            <img src="{{ url_for('static', filename='img/icons/perplexity_icon.png') }}" alt="Perplexity AI" style="width: 24px; height: 24px; margin-right: 10px;" onerror="this.src='https://www.perplexity.ai/favicon.ico';">
                                            <span style="font-size: 16px; font-weight: 600; color: #4a6cfd;">Powered by Perplexity DeepResearch — Model: sonar-deep-research</span>
                                        </div>
                                        <div class="text-center mt-2">
                                            <small class="text-muted">Reports include comprehensive sources and interactive visualizations to help you make informed decisions</small>
                                        </div>
                                    </div>
                                    
                                    <div class="calendar-grid">
                                        {% if earnings_by_week %}
                                            {% for week_id, earnings in earnings_by_week.items() %}
                                                <div class="calendar-week">
                                                    <div class="calendar-week-header">
                                                        {{ week_id }}
                                                        <div class="week-dates">
                                                            {% set first_date = earnings[0].earnings_date %}
                                                            {% set last_date = earnings[-1].earnings_date %}
                                                            {% set first_parts = first_date.split('-') %}
                                                            {% set last_parts = last_date.split('-') %}
                                                            {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                                                            
                                                            {{ month_names[first_parts[1]|int - 1] }} {{ first_parts[2]|int }} - {{ month_names[last_parts[1]|int - 1] }} {{ last_parts[2]|int }}, {{ first_parts[0] }}
                                                        </div>
                                                    </div>
                                                    <div class="calendar-week-body">
                                                        <!-- Group earnings by date -->
                                                        {% set dates_in_week = {} %}
                                                        {% for earning in earnings %}
                                                            {% if earning.earnings_date not in dates_in_week %}
                                                                {% set dates_in_week = dates_in_week.update({earning.earnings_date: []}) or dates_in_week %}
                                                            {% endif %}
                                                            {% set _ = dates_in_week[earning.earnings_date].append(earning) %}
                                                        {% endfor %}
                                                        
                                                        <!-- Render weekdays (Mon-Fri) -->
                                                        <div class="calendar-days">
                                                            {% set weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
                                                            {% for weekday in weekdays %}
                                                                {% set found = False %}
                                                                {% for date, day_earnings in dates_in_week.items() %}
                                                                    {% set date_parts = date.split('-') %}
                                                                    {% set year = date_parts[0]|int %}
                                                                    {% set month = date_parts[1]|int %}
                                                                    {% set day = date_parts[2]|int %}
                                                                    {% set date_obj = date|strptime('%Y-%m-%d') %}
                                                                    {% set weekday_idx = date_obj.weekday() %}
                                                                    {% set weekday_name = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][weekday_idx] %}
                                                                    
                                                                    {% if weekday_name == weekday and weekday_idx < 5 %}
                                                                        {% set found = True %}
                                                                        {% set is_today = date == today %}
                                                                        <div class="calendar-day">
                                                                            <div class="day-header {% if is_today %}today{% endif %}">
                                                                                <div>{{ weekday }}</div>
                                                                                <div>{{ month_names[month-1] }} {{ day }}</div>
                                                                            </div>
                                                                            <div class="day-content">
                                                                                {% for earning in day_earnings %}
                                                                                    {% set in_portfolio = earning.symbol in portfolio_symbols %}
                                                                                    <div class="earnings-item {% if in_portfolio %}earnings-item-portfolio{% endif %}" data-symbol="{{ earning.symbol }}" data-in-portfolio="{{ in_portfolio|lower }}">
                                                                                        <div class="stock-info">
                                                                                            <img src="{{ url_for('company_logo', symbol=earning.symbol) }}" 
                                                                                                 alt="{{ earning.symbol }} logo" 
                                                                                                 class="stock-logo">
                                                                                            <div class="stock-details">
                                                                                                <div class="stock-symbol">
                                                                                                    {{ earning.symbol }}
                                                                                                    {% if in_portfolio %}
                                                                                                        <span class="portfolio-indicator">Portfolio</span>
                                                                                                    {% endif %}
                                                                                                    {% if earning.time_of_day %}
                                                                                                        <span class="earnings-time {% if earning.time_of_day == 'BMO' %}bmo{% elif earning.time_of_day == 'AMC' %}amc{% endif %}">
                                                                                                            {{ earning.time_of_day }}
                                                                                                        </span>
                                                                                                    {% endif %}
                                                                                                </div>
                                                                                                <div class="stock-name">{{ earning.company_name }}</div>
                                                                                            </div>
                                                                                        </div>
                                                                                        {% if earning.eps_estimate %}
                                                                                            <div class="earnings-metrics">
                                                                                                EPS Est: ${% if earning.eps_estimate is string %}{{ earning.eps_estimate }}{% else %}{{ "%.2f"|format(earning.eps_estimate) }}{% endif %}
                                                                                                {% if in_portfolio %}
                                                                                                    {% for stock in portfolio %}
                                                                                                        {% if stock.Symbol == earning.symbol %}
                                                                                                            <div class="position-info mt-1">
                                                                                                                <small class="text-muted">Your position: {{ stock.CurrentShares|round|int }} shares
                                                                                                                {% if current_prices.get(stock.Symbol) %}
                                                                                                                    (~${{ (stock.CurrentShares * current_prices.get(stock.Symbol))|round|int }})
                                                                                                                {% endif %}
                                                                                                                </small>
                                                                                                            </div>
                                                                                                        {% endif %}
                                                                                                    {% endfor %}
                                                                                                {% endif %}
                                                                                            </div>
                                                                                        {% endif %}
                                                                                        <div class="earnings-actions">
                                                                                            <button class="btn btn-sm btn-primary research-btn" 
                                                                                                    data-symbol="{{ earning.symbol }}" 
                                                                                                    data-date="{{ earning.earnings_date }}"
                                                                                                    data-toggle="modal" 
                                                                                                    data-target="#researchModal">
                                                                                                Research
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                {% endfor %}
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                                
                                                                {% if not found %}
                                                                    <div class="calendar-day">
                                                                        <div class="day-header">
                                                                            <div>{{ weekday }}</div>
                                                                            <div>-</div>
                                                                        </div>
                                                                        <div class="day-content">
                                                                            <div class="no-earnings">No earnings</div>
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        <!-- Render weekend (Sat-Sun) -->
                                                        <div class="calendar-weekend">
                                                            {% set weekend_days = ['Saturday', 'Sunday'] %}
                                                            {% for weekday in weekend_days %}
                                                                {% set found = False %}
                                                                {% for date, day_earnings in dates_in_week.items() %}
                                                                    {% set date_parts = date.split('-') %}
                                                                    {% set year = date_parts[0]|int %}
                                                                    {% set month = date_parts[1]|int %}
                                                                    {% set day = date_parts[2]|int %}
                                                                    {% set date_obj = date|strptime('%Y-%m-%d') %}
                                                                    {% set weekday_idx = date_obj.weekday() %}
                                                                    {% set weekday_name = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][weekday_idx] %}
                                                                    
                                                                    {% if weekday_name == weekday and weekday_idx >= 5 %}
                                                                        {% set found = True %}
                                                                        {% set is_today = date == today %}
                                                                        <div class="calendar-day">
                                                                            <div class="day-header weekend {% if is_today %}today{% endif %}">
                                                                                <div>{{ weekday }}</div>
                                                                                <div>{{ month_names[month-1] }} {{ day }}</div>
                                                                            </div>
                                                                            <div class="day-content">
                                                                                {% for earning in day_earnings %}
                                                                                    {% set in_portfolio = earning.symbol in portfolio_symbols %}
                                                                                    <div class="earnings-item {% if in_portfolio %}earnings-item-portfolio{% endif %}" data-symbol="{{ earning.symbol }}" data-in-portfolio="{{ in_portfolio|lower }}">
                                                                                        <div class="stock-info">
                                                                                            <img src="{{ url_for('company_logo', symbol=earning.symbol) }}" 
                                                                                                 alt="{{ earning.symbol }} logo" 
                                                                                                 class="stock-logo">
                                                                                            <div class="stock-details">
                                                                                                <div class="stock-symbol">
                                                                                                    {{ earning.symbol }}
                                                                                                    {% if in_portfolio %}
                                                                                                        <span class="portfolio-indicator">Portfolio</span>
                                                                                                    {% endif %}
                                                                                                    {% if earning.time_of_day %}
                                                                                                        <span class="earnings-time {% if earning.time_of_day == 'BMO' %}bmo{% elif earning.time_of_day == 'AMC' %}amc{% endif %}">
                                                                                                            {{ earning.time_of_day }}
                                                                                                        </span>
                                                                                                    {% endif %}
                                                                                                </div>
                                                                                                <div class="stock-name">{{ earning.company_name }}</div>
                                                                                            </div>
                                                                                        </div>
                                                                                        {% if earning.eps_estimate %}
                                                                                            <div class="earnings-metrics">
                                                                                                EPS Est: ${% if earning.eps_estimate is string %}{{ earning.eps_estimate }}{% else %}{{ "%.2f"|format(earning.eps_estimate) }}{% endif %}
                                                                                                {% if in_portfolio %}
                                                                                                    {% for stock in portfolio %}
                                                                                                        {% if stock.Symbol == earning.symbol %}
                                                                                                            <div class="position-info mt-1">
                                                                                                                <small class="text-muted">Your position: {{ stock.CurrentShares|round|int }} shares
                                                                                                                {% if current_prices.get(stock.Symbol) %}
                                                                                                                    (~${{ (stock.CurrentShares * current_prices.get(stock.Symbol))|round|int }})
                                                                                                                {% endif %}
                                                                                                                </small>
                                                                                                            </div>
                                                                                                        {% endif %}
                                                                                                    {% endfor %}
                                                                                                {% endif %}
                                                                                            </div>
                                                                                        {% endif %}
                                                                                        <div class="earnings-actions">
                                                                                            <button class="btn btn-sm btn-primary research-btn" 
                                                                                                    data-symbol="{{ earning.symbol }}" 
                                                                                                    data-date="{{ earning.earnings_date }}"
                                                                                                    data-toggle="modal" 
                                                                                                    data-target="#researchModal">
                                                                                                Research
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                {% endfor %}
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                                
                                                                {% if not found %}
                                                                    <div class="calendar-day">
                                                                        <div class="day-header weekend">
                                                                            <div>{{ weekday }}</div>
                                                                            <div>-</div>
                                                                        </div>
                                                                        <div class="day-content">
                                                                            <div class="no-earnings">No earnings</div>
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="alert alert-info">
                                                No upcoming earnings found. Try refreshing the calendar.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column - AI Research Jobs -->
                        <div class="col-lg-4">
                            <div class="research-card">
                                <div class="research-card-header">
                                    <h5 class="mb-0">Earnings Research</h5>
                                </div>
                                <div class="earnings-card-body">
                                    <p>Request detailed AI research on a company's upcoming earnings report to get insights on:</p>
                                    
                                    <ul class="mb-4">
                                        <li>Recent company performance and key metrics</li>
                                        <li>Analyst expectations for the upcoming report</li>
                                        <li>Market sentiment and trading patterns</li>
                                        <li>Potential impact on stock price post-earnings</li>
                                    </ul>
                                    
                                    <div class="research-jobs">
                                        <h6 class="mb-3">Recent Research</h6>
                                        {% if earnings_jobs %}
                                            {% for job in earnings_jobs %}
                                                <div class="job-item">
                                                    <div class="job-details">
                                                        <div class="job-symbol">{{ job.symbol }}</div>
                                                        <div class="job-date">Earnings: {{ job.earnings_date }}</div>
                                                    </div>
                                                    <div class="job-status">
                                                        <span class="status-badge status-{{ job.status }}">{{ job.status|title }}</span>
                                                        {% if job.status == 'completed' %}
                                                            <button class="btn btn-sm btn-outline-primary ml-2 view-research-btn" 
                                                                   data-job-id="{{ job.job_id }}" 
                                                                   data-symbol="{{ job.symbol }}" 
                                                                   data-date="{{ job.earnings_date }}"
                                                                   data-toggle="modal" 
                                                                   data-target="#researchResultModal">View</button>
                                                        {% elif job.status == 'failed' %}
                                                            <button class="btn btn-sm btn-outline-danger ml-2" data-toggle="tooltip" title="Research failed, try again">!</button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="alert alert-light text-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-search mb-3" viewBox="0 0 16 16">
                                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                                </svg>
                                                <p>No research jobs yet. Start by clicking "Research" on any upcoming earnings.</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Research Modal -->
            <div class="modal fade" id="researchModal" tabindex="-1" role="dialog" aria-labelledby="researchModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="researchModalLabel">Request Earnings Research</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form action="{{ url_for('earnings_companion') }}" method="post">
                            <div class="modal-body">
                                <div id="stockInfo" class="mb-3 p-3 bg-light rounded">
                                    <div class="d-flex align-items-center mb-2">
                                        <img id="stockLogo" src="" alt="Stock Logo" class="mr-2" style="width: 30px; height: 30px;">
                                        <h5 id="stockTitle" class="mb-0"></h5>
                                    </div>
                                    <div id="earningsDate" class="text-muted"></div>
                                    <div id="portfolioStatus" class="mt-2"></div>
                                </div>
                                
                                <p>Request detailed AI analysis on the upcoming earnings report. The analysis will include:</p>
                                
                                <ul class="mb-3">
                                    <li>Recent company performance metrics</li>
                                    <li>Analyst expectations and whisper numbers</li>
                                    <li>Key focus areas for this report</li>
                                    <li>Recent news that might impact results</li>
                                    <li>Potential price movement scenarios</li>
                                </ul>
                                
                                <div class="form-group">
                                    <input type="hidden" class="form-control" id="symbol" name="symbol">
                                    <input type="hidden" class="form-control" id="earnings_date" name="earnings_date">
                                </div>
                                
                                <p class="text-muted">
                                    <small>
                                        Analysis is generated using Perplexity's {{ settings.perplexity_model }} model. 
                                        Research will be available within 1-2 minutes after submission.
                                    </small>
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Request Research</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Research Result Modal -->
            <div class="modal fade" id="researchResultModal" tabindex="-1" role="dialog" aria-labelledby="researchResultModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document" style="max-width: 90vw;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="researchResultModalLabel">Earnings Research Report</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="researchContent" class="p-3">
                                <div class="d-flex justify-content-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="text-center w-100">
                                <small class="text-muted">Powered by Perplexity DeepResearch — Sources fully cited and verified</small>
                            </div>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
            <script>
                $(document).ready(function() {
                    // Handle filter clicks
                    $('.filter-item').click(function() {
                        $('.filter-item').removeClass('active');
                        $(this).addClass('active');
                        
                        const filter = $(this).data('filter');
                        
                        if (filter === 'all') {
                            $('.earnings-item').show();
                        } else if (filter === 'portfolio') {
                            $('.earnings-item').hide();
                            $('.earnings-item[data-in-portfolio="true"]').show();
                        }
                    });
                    
                    // Handle research button clicks with enhanced info
                    $('.research-btn').click(function() {
                        const symbol = $(this).data('symbol');
                        const date = $(this).data('date');
                        const inPortfolio = $(this).closest('.earnings-item').data('in-portfolio');
                        const companyName = $(this).closest('.earnings-item').find('.stock-name').text();
                        
                        // Format date for display
                        const dateObj = new Date(date);
                        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                        const formattedDate = dateObj.toLocaleDateString('en-US', options);
                        
                        // Get the logo URL from our cached system
                        const logoUrl = "{{ url_for('company_logo', symbol='') }}" + symbol;
                        
                        // Update the modal with enhanced information
                        $('#symbol').val(symbol);
                        $('#earnings_date').val(date);
                        $('#stockLogo').attr('src', logoUrl);
                        $('#stockTitle').text(`${symbol} - ${companyName}`);
                        $('#earningsDate').text(`Earnings Date: ${formattedDate}`);
                        $('#researchModalLabel').text(`Earnings Research: ${symbol}`);
                        
                        // Add portfolio status if applicable
                        if (inPortfolio) {
                            let portfolioHtml = '<span class="badge badge-success">In Your Portfolio</span>';
                            
                            // Try to find position info
                            const positionInfo = $(this).closest('.earnings-item').find('.position-info').text();
                            if (positionInfo) {
                                portfolioHtml += `<div class="mt-1"><small>${positionInfo}</small></div>`;
                            }
                            
                            $('#portfolioStatus').html(portfolioHtml);
                        } else {
                            $('#portfolioStatus').html('<span class="badge badge-secondary">Not In Portfolio</span>');
                        }
                    });
                    
                    // Handle view research button clicks
                    $('.view-research-btn').click(function() {
                        const jobId = $(this).data('job-id');
                        const symbol = $(this).data('symbol');
                        const date = $(this).data('date');
                        
                        // Update modal title
                        $('#researchResultModalLabel').text(`Earnings Research: ${symbol} (${date})`);
                        
                        // Show loading spinner
                        $('#researchContent').html(`
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        `);
                        
                        // Fetch job data from API
                        $.ajax({
                            url: `{{ url_for('api_earnings_job', job_id='') }}${jobId}`,
                            method: 'GET',
                            success: function(response) {
                                if (response && response.result) {
                                    // Convert markdown to HTML
                                    const converter = new showdown.Converter({
                                        tables: true,
                                        simplifiedAutoLink: true,
                                        strikethrough: true,
                                        tasklists: true
                                    });
                                    const html = converter.makeHtml(response.result);
                                    
                                    // Add CSS for better markdown rendering for better readability
                                    $('#researchContent').html(`
                                        <style>
                                            .markdown-body {
                                                padding: 20px;
                                                border-radius: 8px; 
                                                border: 1px solid #e9ecef;
                                                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                                            }
                                            
                                            .markdown-body h1 {
                                                padding-bottom: 10px;
                                                border-bottom: 1px solid #e9ecef;
                                                margin-bottom: 20px;
                                            }
                                            
                                            .markdown-body h2 {
                                                margin-top: 24px;
                                                margin-bottom: 16px;
                                                font-weight: 600;
                                                padding-bottom: 5px;
                                                border-bottom: 1px solid #e9ecef;
                                            }
                                            
                                            .markdown-body h3 {
                                                margin-top: 24px;
                                                margin-bottom: 16px;
                                                font-weight: 600;
                                            }
                                            
                                            .markdown-body p {
                                                margin-bottom: 16px;
                                                line-height: 1.6;
                                            }
                                            
                                            .markdown-body ul, .markdown-body ol {
                                                margin-bottom: 16px;
                                                padding-left: 2em;
                                            }
                                            
                                            .markdown-body li {
                                                margin-bottom: 4px;
                                            }
                                            
                                            .markdown-body blockquote {
                                                padding: 0 1em;
                                                color: #6c757d;
                                                border-left: 0.25em solid #e9ecef;
                                            }
                                            
                                            .markdown-body pre {
                                                padding: 16px;
                                                overflow: auto;
                                                background-color: #f6f8fa;
                                                border-radius: 6px;
                                            }
                                            
                                            .markdown-body code {
                                                padding: 0.2em 0.4em;
                                                background-color: #f6f8fa;
                                                border-radius: 3px;
                                                font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
                                            }
                                            
                                            .markdown-body a {
                                                color: #4a6cfd;
                                                text-decoration: none;
                                            }
                                            
                                            .markdown-body a:hover {
                                                text-decoration: underline;
                                            }
                                            
                                            .markdown-body img {
                                                max-width: 100%;
                                                height: auto;
                                                display: block;
                                                margin: 20px 0;
                                            }
                                            
                                            /* Improved table styles */
                                            .markdown-body table {
                                                width: 100%;
                                                margin: 20px 0;
                                                border-collapse: collapse;
                                            }
                                            
                                            .markdown-body table th,
                                            .markdown-body table td {
                                                padding: 12px;
                                                border: 1px solid #e9ecef;
                                            }
                                            
                                            .markdown-body table th {
                                                background-color: #f8f9fa;
                                                font-weight: 600;
                                            }
                                            
                                            .markdown-body table tr:nth-child(even) {
                                                background-color: #f8f9fa;
                                            }
                                            
                                            /* Sources section styles */
                                            #sources-section {
                                                margin-top: 40px;
                                                padding: 20px;
                                                background-color: #f8f9fa;
                                                border-radius: 8px;
                                                border: 1px solid #e9ecef;
                                            }
                                            
                                            #sources-section h2 {
                                                margin-top: 0;
                                                padding-bottom: 10px;
                                                border-bottom: 1px solid #dee2e6;
                                                color: #343a40;
                                                font-size: 1.5rem;
                                            }
                                            
                                            .source-item {
                                                margin-bottom: 10px;
                                                padding-bottom: 10px;
                                                border-bottom: 1px solid #e9ecef;
                                            }
                                            
                                            .source-item:last-child {
                                                border-bottom: none;
                                                margin-bottom: 0;
                                                padding-bottom: 0;
                                            }
                                            
                                            .source-item a {
                                                color: #4a6cfd;
                                                text-decoration: none;
                                                word-break: break-word;
                                            }
                                            
                                            .source-item a:hover {
                                                text-decoration: underline;
                                            }
                                            
                                            .source-date {
                                                font-size: 0.85rem;
                                                color: #6c757d;
                                                display: block;
                                                margin-top: 2px;
                                            }

                                            /* Navigation for markdown */
                                            .markdown-nav {
                                                background-color: #f8f9fa;
                                                border-radius: 8px;
                                                padding: 15px;
                                                margin-bottom: 20px;
                                                border: 1px solid #e9ecef;
                                            }
                                            
                                            .markdown-nav-title {
                                                font-weight: 600;
                                                margin-bottom: 10px;
                                                color: #495057;
                                            }
                                            
                                            .markdown-nav-list {
                                                list-style-type: none;
                                                padding-left: 0;
                                                margin-bottom: 0;
                                        }
                                            
                                            .markdown-nav-item {
                                                margin-bottom: 5px;
                                            }
                                            
                                            .markdown-nav-link {
                                                color: #4a6cfd;
                                                text-decoration: none;
                                                font-size: 0.9rem;
                                                display: block;
                                                padding: 5px 10px;
                                                border-radius: 4px;
                                                transition: background-color 0.2s;
                                }
                                            
                                            .markdown-nav-link:hover {
                                                background-color: #e9ecef;
                                                text-decoration: none;
                                            }

                                            .markdown-nav-link.active {
                                                background-color: #e9ecef;
                                                font-weight: 600;
                                            }
                                            
                                            /* Fix for visualization section */
                                            .visualization-section {
                                                display: none; /* Hide the visualization section */
                                            }
                                        </style>
                                        <div class="markdown-body">${html}</div>
                                `);

                                    // Fix direct API responses
                                    function fixDirectApiResponse() {
                                        const content = document.querySelector('.markdown-body');
                                        if (!content) return;
                        
                                        // Check if content appears to be a non-formatted API response
                                        const contentText = content.textContent || '';
                                        if (contentText.includes('## Company Overview') && !content.querySelector('h2')) {
                                            // It's likely raw text that needs to be re-formatted
                                            // Create a clean version of the markdown text
                                            let cleanedMarkdown = contentText
                                                .replace(/#([^#\n]+)/g, '\n# $1\n') // Add newlines around h1
                                                .replace(/##([^#\n]+)/g, '\n## $1\n') // Add newlines around h2
                                                .replace(/\*\*([^*]+)\*\*/g, '**$1**') // Preserve bold text
                                                .replace(/\|\s*\|/g, '|') // Fix table separators
                                                .replace(/--+/g, '---') // Fix horizontal rules
                                                .replace(/\s+\|/g, ' |') // Fix spacing in tables
                                                .replace(/\|\s+/g, '| ') // Fix spacing in tables
                                                .replace(/(\d+)\.\s+/g, '$1. '); // Fix numbered lists
                                                
                                            // Convert the cleaned markdown back to HTML
                                            const converter = new showdown.Converter({
                                                tables: true,
                                                simplifiedAutoLink: true,
                                                strikethrough: true,
                                                tasklists: true
                                            });
                                            content.innerHTML = converter.makeHtml(cleanedMarkdown);
                                        }
                                    }

                                    // Add table of contents navigation
                                    function addTableOfContents() {
                                        const contentDiv = document.querySelector('.markdown-body');
                                        const headers = contentDiv.querySelectorAll('h2');
                                        
                                        if (headers.length > 2) { // Only add TOC if there are enough headers
                                            const nav = document.createElement('div');
                                            nav.className = 'markdown-nav';
                                            
                                            const title = document.createElement('div');
                                            title.className = 'markdown-nav-title';
                                            title.textContent = 'Table of Contents';
                                            
                                            const list = document.createElement('ul');
                                            list.className = 'markdown-nav-list';
                                            
                                            headers.forEach((header, index) => {
                                                // Add ID to the header if it doesn't have one
                                                if (!header.id) {
                                                    header.id = 'section-' + index;
                                                }
                                                
                                                const listItem = document.createElement('li');
                                                listItem.className = 'markdown-nav-item';
                                                
                                                const link = document.createElement('a');
                                                link.className = 'markdown-nav-link';
                                                link.href = '#' + header.id;
                                                link.textContent = header.textContent;
                                                
                                                listItem.appendChild(link);
                                                list.appendChild(listItem);
                                
                                                // Add click event for smooth scrolling
                                                link.addEventListener('click', function(e) {
                                                    e.preventDefault();
                                                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                                                        behavior: 'smooth'
                                                    });
                                                    
                                                    // Update active link
                                                    document.querySelectorAll('.markdown-nav-link').forEach(link => {
                                                        link.classList.remove('active');
                                                    });
                                                    this.classList.add('active');
                                                });
                                            });
                                            
                                            nav.appendChild(title);
                                            nav.appendChild(list);
                                            
                                            // Insert TOC at the top of the content
                                            contentDiv.insertBefore(nav, contentDiv.firstChild);
                                        }
                                    }

                                    // Process the sources section
                                    const processSourcesSection = function() {
                                        const markdownContent = document.querySelector('.markdown-body');
                                        if (!markdownContent) return;
                                        
                                        // Find sources section
                                        const sourcesHeader = markdownContent.querySelector('h2:last-of-type');
                                        if (sourcesHeader && sourcesHeader.textContent.trim().toLowerCase() === 'sources') {
                                            // Create a new dedicated sources section
                                            const sourcesSection = document.createElement('div');
                                            sourcesSection.id = 'sources-section';
                                            
                                            // Add a header
                                            const sourcesTitle = document.createElement('h2');
                                            sourcesTitle.textContent = 'Sources';
                                            sourcesSection.appendChild(sourcesTitle);
                                            
                                            // Get all of the elements that are part of the sources section
                                            let sourceElements = [];
                                            let sourceSection = sourcesHeader.nextElementSibling;
                                            
                                            // Process source elements
                                            let sourcesList = document.createElement('div');
                                            sourcesSection.appendChild(sourcesList);
                                            
                                            while (sourceSection) {
                                                // If we've reached another header, we're done with sources
                                                if (sourceSection.tagName.match(/^H[1-6]$/i)) break;
                                                
                                                // Create a source item
                                                const sourceItem = document.createElement('div');
                                                sourceItem.className = 'source-item';
                                                sourceItem.innerHTML = sourceSection.outerHTML;
                                                sourcesList.appendChild(sourceItem);
                            
                                                // Add to list of elements to remove
                                                sourceElements.push(sourceSection);
                                                
                                                // Move to next element
                                                sourceSection = sourceSection.nextElementSibling;
                                            }
                                            
                                            // Remove original sources header and elements
                                            sourcesHeader.remove();
                                            sourceElements.forEach(el => el.remove());
                                            
                                            // Add the new sources section after the markdown content
                                            markdownContent.parentNode.insertBefore(sourcesSection, markdownContent.nextSibling);
                                            
                                            // Process inline citations if any (like [1], [2], etc.)
                                            Array.from(markdownContent.querySelectorAll('a')).forEach(link => {
                                                const text = link.textContent.trim();
                                                const href = link.getAttribute('href');
                                                
                                                // Check if this is a citation link
                                                if (text.match(/^\[\d+\]$/) && !href.startsWith('http')) {
                                                    // This is likely a citation. Replace it with a proper footnote
                                                    const citation = text.replace(/[\[\]]/g, '');
                                                    const footnote = document.createElement('sup');
                                                    footnote.className = 'citation-ref';
                                                    footnote.textContent = citation;
                                                    link.parentNode.replaceChild(footnote, link);
                                }
                            });
                        }
                                    };

                                    // Process tables to ensure proper rendering
                                    const processTablesForRendering = function() {
                                        const markdownContent = document.querySelector('.markdown-body');
                                        if (!markdownContent) return;
                                        
                                        // Check if any text contains table-like structures
                                        const contentText = markdownContent.textContent;
                                        
                                        // If we have table-like structures but no rendered tables, manually create them
                                        if (contentText.includes('|') && contentText.includes('---') && !markdownContent.querySelector('table')) {
                                            // Find potential table sections in the text
                                            const tableRegex = /\|[^\n]+\|\n\|[\s\-:]+\|\n(\|[^\n]+\|\n)+/g;
                                            const rawTableMatches = contentText.match(tableRegex) || [];
                                            
                                            if (rawTableMatches.length > 0) {
                                                // For each raw table, create a properly formatted table
                                                rawTableMatches.forEach(rawTable => {
                                                    // Find the paragraph containing this raw table content
                                                    const paragraphs = markdownContent.querySelectorAll('p');
                                                    for (let i = 0; i < paragraphs.length; i++) {
                                                        if (paragraphs[i].textContent.includes(rawTable.substring(0, 30))) {
                                                            // Create table element
                                                            const table = document.createElement('table');
                                                            table.className = 'table table-bordered table-hover';
                                                            
                                                            // Split the raw table by lines
                                                            const lines = rawTable.trim().split('\n');
                                                            
                                                            // Create header
                                                            const thead = document.createElement('thead');
                                                            thead.className = 'thead-light';
                                                            const headerRow = document.createElement('tr');
                            
                                                            // Process header cells
                                                            const headerCells = lines[0].split('|').filter(cell => cell.trim() !== '');
                                                            headerCells.forEach(cell => {
                                                                const th = document.createElement('th');
                                                                th.textContent = cell.trim();
                                                                headerRow.appendChild(th);
                                                            });
                                                            
                                                            thead.appendChild(headerRow);
                                                            table.appendChild(thead);
                                                            
                                                            // Create body
                                                            const tbody = document.createElement('tbody');
                            
                                                            // Skip header and separator lines
                                                            for (let j = 2; j < lines.length; j++) {
                                                                const row = document.createElement('tr');
                                                                
                                                                // Process data cells
                                                                const cells = lines[j].split('|').filter(cell => cell.trim() !== '');
                                                                cells.forEach(cell => {
                                                                    const td = document.createElement('td');
                                                                    td.textContent = cell.trim();
                                                                    row.appendChild(td);
                                                                });
                                                                
                                                                tbody.appendChild(row);
                                                            }
                                                            
                                                            table.appendChild(tbody);
                                                            
                                                            // Replace the paragraph with the table
                                                            paragraphs[i].parentNode.replaceChild(table, paragraphs[i]);
                                                            break;
                                                        }
                                                    }
                                                });
                                            }
                                        } else {
                                            // Just enhance existing tables
                                            const tables = markdownContent.querySelectorAll('table');
                                            tables.forEach(table => {
                                                table.classList.add('table', 'table-bordered', 'table-hover');
                                                
                                                // Ensure there's a thead
                                                if (!table.querySelector('thead')) {
                                                    const firstRow = table.querySelector('tr');
                                                    if (firstRow) {
                                                        const thead = document.createElement('thead');
                                                        thead.classList.add('thead-light');
                                                        
                                                        // Move the first row to the thead
                                                        thead.appendChild(firstRow);
                                                        table.insertBefore(thead, table.firstChild);
                                                        
                                                        // Convert td to th in the header row
                                                        const cells = firstRow.querySelectorAll('td');
                                                        cells.forEach(cell => {
                                                            const th = document.createElement('th');
                                                            th.innerHTML = cell.innerHTML;
                                                            cell.parentNode.replaceChild(th, cell);
                                                        });
                                    }
                                }
                            });
                        }
                                    };

                                    // Add copy button to code blocks and enhance tables
                                    setTimeout(function() {
                                        // First fix any direct API responses that aren't properly formatted
                                        fixDirectApiResponse();
                                        
                                        // After fixing the content, add the navigation
                                        setTimeout(function() {
                                            addTableOfContents();
                                            
                                            // Remove any code blocks that may be wrapping the content
                                            const codeBlocks = document.querySelectorAll('code.markdown, code.language-markdown');
                                            codeBlocks.forEach(codeBlock => {
                                                // Get the parent pre if it exists
                                                const preParent = codeBlock.closest('pre');
                                                if (preParent) {
                                                    // Replace the pre with the code content
                                                    const content = codeBlock.innerHTML;
                                                    const tempDiv = document.createElement('div');
                                                    tempDiv.innerHTML = content;
                                                    preParent.parentNode.replaceChild(tempDiv, preParent);
                                                } else {
                                                    // If there's no pre parent, unwrap the code tag
                                                    const content = codeBlock.innerHTML;
                                                    const tempDiv = document.createElement('div');
                                                    tempDiv.innerHTML = content;
                                                    while (tempDiv.firstChild) {
                                                        codeBlock.parentNode.insertBefore(tempDiv.firstChild, codeBlock);
                                                    }
                                                    codeBlock.parentNode.removeChild(codeBlock);
                                                }
                                            });
                                            
                                            // Process tables to ensure they render properly
                                            processTablesForRendering();
                            
                                            // Add copy button to code blocks
                                            $('pre code').each(function() {
                                                const $this = $(this);
                                                const $button = $('<button class="btn btn-sm btn-outline-secondary copy-btn" style="position: absolute; top: 8px; right: 8px;">Copy</button>');
                                                $this.parent().css('position', 'relative').append($button);
                                                
                                                $button.click(function() {
                                                    const code = $this.text();
                                                    navigator.clipboard.writeText(code).then(function() {
                                                        $button.text('Copied!');
                                                        setTimeout(function() {
                                                            $button.text('Copy');
                                                        }, 2000);
                                                    });
                                                });
                                            });

                                            // Enhance tables
                                            $('.markdown-body table').addClass('table table-bordered table-hover');
                                            $('.markdown-body thead').addClass('thead-light');
                                            
                                            // Process sources section
                                            processSourcesSection();
                                        }, 200);
                                    }, 200);
                                } else {
                                    $('#researchContent').html(`
                                        <div class="alert alert-danger">
                                            Error loading research results. Please try again.
                                        </div>
                                    `);
                                }
                            },
                            error: function() {
                                $('#researchContent').html(`
                                    <div class="alert alert-danger">
                                        Error loading research results. Please try again.
                                    </div>
                                `);
                                    }
                        });
                            });
                    
                    // Handle calendar refresh
                    $('#refreshCalendar').click(function() {
                        $('#refreshSpinner').show();
                        
                        // Call API to refresh the calendar
                        $.ajax({
                            url: '{{ url_for("api_update_earnings_calendar") }}',
                            method: 'POST',
                            success: function(response) {
                                if (response.status === 'success') {
                                    // Reload the page to show updated calendar
                                    location.reload();
                                } else {
                                    alert('Failed to update calendar. Please try again.');
                                    $('#refreshSpinner').hide();
                                }
                            },
                            error: function() {
                                alert('Failed to update calendar. Please try again.');
                                $('#refreshSpinner').hide();
                            }
                        });
                    });
                    
                    // Set auto-refresh for job status
                    function checkPendingJobs() {
                        const pendingJobs = $('.status-pending, .status-processing').length;
                        if (pendingJobs > 0) {
                            setTimeout(function() {
                                location.reload();
                            }, 30000); // Refresh every 30 seconds if there are pending jobs
                        }
                    }
                    
                    checkPendingJobs();
                    
                    // Initialize tooltips
                    $('[data-toggle="tooltip"]').tooltip();
                    
                    // Preload all company logos for stocks with upcoming earnings
                    function preloadCompanyLogos() {
                        // Get all unique stock symbols from earnings items
                        const symbols = [];
                        
                        $('.earnings-item').each(function() {
                            const symbol = $(this).data('symbol');
                            if (symbol && !symbols.includes(symbol)) {
                                symbols.push(symbol);
                            }
                        });
                        
                        // Preload each logo
                        symbols.forEach(symbol => {
                            $.get(`/company-logo/${symbol}`).then(() => {
                                console.log(`Preloaded logo for ${symbol}`);
                            }).catch(error => {
                                console.error(`Error preloading logo for ${symbol}:`, error);
                            });
                        });
                    }
                    
                    // Run the preload function when the page loads
                    preloadCompanyLogos();
                });
            </script>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
</body>
</html> 